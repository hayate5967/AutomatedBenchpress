<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bench Press Judge Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; text-align: center; padding: 20px; background-color: #1a1a1a; color: white; }
        
        /* æ¥ç¶šãƒœã‚¿ãƒ³ */
        #connectBtn {
            padding: 15px 40px; font-size: 1.2rem; background-color: #007bff; 
            color: white; border: none; border-radius: 50px; cursor: pointer; margin-bottom: 20px;
        }
        
        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .settings-box {
            background-color: #333; padding: 20px; border-radius: 15px;
            margin: 20px auto; max-width: 300px;
            border: 1px solid #555;
        }
        input[type="number"] {
            font-size: 1.5rem; width: 80px; padding: 5px; text-align: center;
            border-radius: 5px; border: none;
        }
        button.set-btn {
            background-color: #28a745; color: white; border: none; padding: 10px 20px;
            font-size: 1rem; border-radius: 5px; margin-left: 10px; cursor: pointer;
        }

        /* åˆ¤å®šè¡¨ç¤º */
        #message { font-size: 4rem; font-weight: 800; margin-top: 30px; color: #ff4757; min-height: 80px;}
        #current-setting { color: #888; margin-top: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <h1>ğŸ‹ï¸â€â™‚ï¸ Bench Press Judge</h1>
    
    <button id="connectBtn" onclick="connectBluetooth()">CONNECT DEVICE</button>
    <p id="status">ãƒ‡ãƒã‚¤ã‚¹æœªæ¥ç¶š</p>

    <div class="settings-box" id="settingsArea" style="opacity: 0.5; pointer-events: none;">
        <h3>æ­¢ã‚ã‚‹ç§’æ•° (ç§’)</h3>
        <div>
            <input type="number" id="secInput" value="0.6" step="0.1" min="0.1" max="5.0">
            <button class="set-btn" onclick="updateTime()">å¤‰æ›´</button>
        </div>
        <p id="current-setting">ç¾åœ¨ã®è¨­å®š: 0.6ç§’</p>
    </div>

    <div id="message"></div>

    <script>
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let device, characteristic;

        async function connectBluetooth() {
            try {
                document.getElementById('status').innerText = "æ¤œç´¢ä¸­...";
                
                device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'BenchPressMonitor' }],
                optionalServices: [SERVICE_UUID]
                 });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_UUID);

                // é€šçŸ¥ã®é–‹å§‹
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                // UIæ›´æ–°
                document.getElementById('status').innerText = "æ¥ç¶šå®Œäº†ï¼";
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('settingsArea').style.opacity = '1';
                document.getElementById('settingsArea').style.pointerEvents = 'auto';
                
                speak("Connected");

                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('status').innerText = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ";
                    document.getElementById('connectBtn').style.display = 'inline-block';
                    document.getElementById('settingsArea').style.opacity = '0.5';
                    document.getElementById('settingsArea').style.pointerEvents = 'none';
                });

            } catch (error) {
                console.error(error);
                alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + error);
            }
        }

        // ESP32ã¸ç§’æ•°ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
        async function updateTime() {
            if (!characteristic) return;

            const sec = document.getElementById('secInput').value;
            const ms = Math.floor(sec * 1000); // 0.6 -> 600

            try {
                // æ–‡å­—åˆ—ã¨ã—ã¦é€ä¿¡ (ä¾‹: "1000")
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(String(ms)));
                
                document.getElementById('current-setting').innerText = `ç¾åœ¨ã®è¨­å®š: ${sec}ç§’`;
                speak(`${sec}ç§’ã«è¨­å®šã—ã¾ã—ãŸ`);
                
            } catch (err) {
                alert("é€ä¿¡å¤±æ•—: " + err);
            }
        }

        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            if (value.includes("PRESS")) {
                document.getElementById('message').innerText = "PRESS!!!";
                speak("ãƒ—ãƒ¬ã‚¹ï¼");
                setTimeout(() => { document.getElementById('message').innerText = ""; }, 3000);
            }
        }

        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = "ja-JP"; 
            uttr.rate = 1.2;
            window.speechSynthesis.speak(uttr);
        }
    </script>
</body>
</html>

