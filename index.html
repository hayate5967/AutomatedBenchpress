<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bench Press Judge</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #222; color: white; }
        h1 { margin-bottom: 40px; }
        #status { font-size: 1.2rem; margin: 20px; color: #aaa; }
        #connectBtn {
            padding: 15px 30px; font-size: 1.2rem; background-color: #007bff; 
            color: white; border: none; border-radius: 50px; cursor: pointer;
        }
        #message { font-size: 3rem; font-weight: bold; margin-top: 50px; color: #ff4757; }
    </style>
</head>
<body>

    <h1>ğŸ‹ï¸â€â™‚ï¸ Bench Press Judge</h1>
    <p id="status">ãƒ‡ãƒã‚¤ã‚¹æœªæ¥ç¶š</p>
    <button id="connectBtn" onclick="connectBluetooth()">CONNECT</button>
    <div id="message"></div>

    <script>
        // ESP32ã§è¨­å®šã—ãŸUUIDã¨åŒã˜ã‚‚ã®
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

        let device;
        let characteristic;

        async function connectBluetooth() {
            try {
                document.getElementById('status').innerText = "æ¤œç´¢ä¸­...";
                
                // 1. ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¢ã™
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'BenchPressMonitor' }],
                    optionalServices: [SERVICE_UUID]
                });

                // 2. æ¥ç¶šã™ã‚‹
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_UUID);

                // 3. é€šçŸ¥ã‚’å—ã‘å–ã‚‹è¨­å®š
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                document.getElementById('status').innerText = "æ¥ç¶šå®Œäº†ï¼åˆ¤å®šå¾…æ©Ÿä¸­...";
                document.getElementById('connectBtn').style.display = 'none';
                
                // æ¥ç¶šç¢ºèªã®éŸ³å£°
                speak("Connected");

                // åˆ‡æ–­æ™‚ã®å‡¦ç†
                device.addEventListener('gattserverdisconnected', () => {
                    document.getElementById('status').innerText = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ";
                    document.getElementById('connectBtn').style.display = 'inline-block';
                });

            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "ã‚¨ãƒ©ãƒ¼: " + error;
            }
        }

        // é€šçŸ¥ãŒæ¥ãŸæ™‚ã®å‡¦ç†
        function handleNotifications(event) {
            const value = new TextDecoder().decode(event.target.value);
            console.log("Received:", value);

            if (value.includes("PRESS")) {
                document.getElementById('message').innerText = "PRESS!!!";
                speak("ãƒ—ãƒ¬ã‚¹ï¼"); // ã“ã“ã§å–‹ã‚‹
                
                // 3ç§’å¾Œã«è¡¨ç¤ºã‚’æ¶ˆã™
                setTimeout(() => {
                    document.getElementById('message').innerText = "";
                }, 3000);
            }
        }

        // éŸ³å£°åˆæˆï¼ˆèª­ã¿ä¸Šã’ï¼‰æ©Ÿèƒ½
        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = "ja-JP"; // æ—¥æœ¬èªè¨­å®š
            uttr.rate = 1.2;     // å°‘ã—æ—©å£
            uttr.pitch = 1.0;
            window.speechSynthesis.speak(uttr);
        }
    </script>
</body>
</html>